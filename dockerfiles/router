FROM python:3.12 as router
RUN pip install poetry==1.8.3
WORKDIR /app
COPY poetry.lock .
COPY pyproject.toml .
COPY README.md .
RUN poetry install --with=router --without=dev
COPY s4 s4
CMD poetry run router


FROM python:3.12 as migration
RUN pip install poetry==1.8.3
WORKDIR /app
COPY poetry.lock .
COPY pyproject.toml .
COPY README.md .
RUN poetry install --with=migration --without=dev,router
COPY alembic.ini .
COPY alembic alembic
COPY s4 s4

CMD poetry run alembic upgrade head
